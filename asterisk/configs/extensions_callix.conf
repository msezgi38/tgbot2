;=============================================================================
; Dialplan Configuration for Press-1 IVR Bot 4 (Sonvia)
;=============================================================================
; This context handles calls for the FOURTH bot instance
; ⚠️ APPEND this to your existing /etc/asterisk/extensions.conf
;=============================================================================

;-----------------------------------------------------------------------------
; Context: press-one-ivr-4
; Entry point for Bot 4 calls (Sonvia)
;-----------------------------------------------------------------------------
[press-one-ivr-4]
exten => _X.,1,NoOp(=== Press-1 IVR Call Started [BOT4-SONVIA] ===)
 same => n,NoOp(CallID: ${CHANNEL(uniqueid)})
 same => n,NoOp(Destination: ${EXTEN})
 same => n,NoOp(CallerID: ${CALLERID(num)})
 same => n,Answer()
 same => n,Wait(0.5)

; Set channel variables for tracking
 same => n,Set(CALL_ID=${CALL_ID})
 same => n,Set(DESTINATION=${EXTEN})
 same => n,Set(DTMF_PRESSED=0)
 same => n,Set(CALL_START=${EPOCH})

; Play IVR intro voice file (dynamic from campaign)
 same => n,NoOp(Playing IVR audio: ${VOICE_FILE})
 same => n,GotoIf($["${VOICE_FILE}" != ""]?play_voice:play_default)
 same => n(play_voice),Playback(${VOICE_FILE})
 same => n,Goto(wait_dtmf)
 same => n(play_default),Playback(custom/press_one_ivr)
 same => n(wait_dtmf),NoOp(Voice file playback complete)

; Wait for DTMF digit with timeout
 same => n,NoOp(Waiting for DTMF input - 10 second timeout)
 same => n,Read(DTMF_INPUT,beep,1,,,10)

; Check if user pressed '1'
 same => n,GotoIf($["${DTMF_INPUT}" = "1"]?pressed_one:no_response)

; User pressed '1' - Success
 same => n(pressed_one),NoOp(User pressed 1 - SUCCESS!)
 same => n,Set(DTMF_PRESSED=1)
 same => n,GotoIf($["${OUTRO_FILE}" != ""]?play_outro:play_thankyou)
 same => n(play_outro),Playback(${OUTRO_FILE})
 same => n,Goto(send_webhook)
 same => n(play_thankyou),Playback(thank-you)
 same => n,Goto(send_webhook)

; No response or wrong digit
 same => n(no_response),NoOp(No valid response received: ${DTMF_INPUT})
 same => n,Set(DTMF_PRESSED=0)
 same => n,Goto(send_webhook)

; Calculate call duration
 same => n(send_webhook),Set(CALL_DURATION=$[${EPOCH} - ${CALL_START}])

; Send webhook to Python bot 4 (PORT 8003)
 same => n,NoOp(Sending DTMF webhook: digit=${DTMF_INPUT} duration=${CALL_DURATION} campaign=${CAMPAIGN_ID})
 same => n,Set(CURL_RESULT=${CURL(http://localhost:8003/webhook/dtmf,call_id=${CALL_ID}&digit=${DTMF_INPUT}&duration=${CALL_DURATION}&campaign_id=${CAMPAIGN_ID}&campaign_data_id=${CAMPAIGN_DATA_ID})})
 same => n,NoOp(Webhook response: ${CURL_RESULT})

; Cleanup and hangup
 same => n,NoOp(Call completed - Hanging up)
 same => n,Hangup()

 same => n(call_failed),NoOp(Call failed or hungup early)
 same => n,Hangup()

;-----------------------------------------------------------------------------
; Context: from-sonvia
; Handles incoming calls from Sonvia (reject - outbound only)
;-----------------------------------------------------------------------------
[from-sonvia]
exten => _X.,1,NoOp(Incoming call from Sonvia: ${CALLERID(all)})
 same => n,NoOp(This trunk is outbound-only - rejecting)
 same => n,Busy()
 same => n,Hangup()

;=============================================================================
; KEY DIFFERENCE FROM OTHER BOTS:
; - Context name: press-one-ivr-4
; - Webhook port: 8003, endpoint: /webhook/dtmf
; - From context: from-sonvia
;=============================================================================
