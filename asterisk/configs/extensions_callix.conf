;=============================================================================
; Dialplan Configuration for Press-1 IVR Bot 2 (Callix)
;=============================================================================
; This context handles calls for the SECOND bot instance
; ⚠️ APPEND this to your existing /etc/asterisk/extensions.conf
;=============================================================================

;-----------------------------------------------------------------------------
; Context: press-one-ivr-2
; Entry point for Bot 2 calls (Callix trunk)
;-----------------------------------------------------------------------------
[press-one-ivr-2]
exten => _X.,1,NoOp(=== Press-1 IVR Call Started [BOT2-CALLIX] ===)
 same => n,NoOp(CallID: ${CHANNEL(uniqueid)})
 same => n,NoOp(Destination: ${EXTEN})
 same => n,NoOp(CallerID: ${CALLERID(num)})
 same => n,Answer()
 same => n,Wait(0.5)

; Set channel variables for tracking
 same => n,Set(CALL_ID=${CHANNEL(uniqueid)})
 same => n,Set(DESTINATION=${EXTEN})
 same => n,Set(DTMF_PRESSED=0)

; Play IVR intro voice file (dynamic from campaign)
 same => n,NoOp(Playing IVR audio: ${VOICE_FILE})
 same => n,GotoIf($["${VOICE_FILE}" != ""]?play_voice:play_default)
 same => n(play_voice),Playback(${VOICE_FILE})
 same => n,Goto(wait_dtmf)
 same => n(play_default),Playback(custom/press_one_ivr)
 same => n(wait_dtmf),NoOp(Voice file playback complete)

; Wait for DTMF digit with timeout
 same => n,NoOp(Waiting for DTMF input - 10 second timeout)
 same => n,Read(DTMF_INPUT,beep,1,,,10)

; Check if user pressed '1'
 same => n,GotoIf($["${DTMF_INPUT}" = "1"]?pressed_one:no_response)

; User pressed '1' - Success
 same => n(pressed_one),NoOp(User pressed 1 - SUCCESS!)
 same => n,Set(DTMF_PRESSED=1)
 same => n,GotoIf($["${OUTRO_FILE}" != ""]?play_outro:play_thankyou)
 same => n(play_outro),Playback(${OUTRO_FILE})
 same => n,Goto(send_webhook)
 same => n(play_thankyou),Playback(thank-you)
 same => n,Goto(send_webhook)

; No response or wrong digit
 same => n(no_response),NoOp(No valid response received: ${DTMF_INPUT})
 same => n,Set(DTMF_PRESSED=0)
 same => n,Goto(send_webhook)

; Send webhook to Python bot 2 (PORT 8001 - different from bot 1!)
 same => n(send_webhook),NoOp(Sending webhook notification to Bot 2)
 same => n,Set(CURL_RESULT=${CURL(http://localhost:8001/dtmf_webhook,call_id=${CALL_ID}&destination=${DESTINATION}&dtmf_pressed=${DTMF_PRESSED}&callerid=${CALLERID(num)})})
 same => n,NoOp(Webhook response: ${CURL_RESULT})

; Cleanup and hangup
 same => n,NoOp(Call completed - Hanging up)
 same => n,Hangup()

 same => n(call_failed),NoOp(Call failed or hungup early)
 same => n,Hangup()

;-----------------------------------------------------------------------------
; Context: from-callix
; Handles incoming calls from Callix (reject - outbound only)
;-----------------------------------------------------------------------------
[from-callix]
exten => _X.,1,NoOp(Incoming call from Callix: ${CALLERID(all)})
 same => n,NoOp(This trunk is outbound-only - rejecting)
 same => n,Busy()
 same => n,Hangup()

;=============================================================================
; KEY DIFFERENCE FROM BOT 1:
; - Context name: press-one-ivr-2 (not press-one-ivr)
; - Webhook port: 8001 (not 8000)
; - From context: from-callix (not from-magnus)
; - VOICE_FILE and OUTRO_FILE are dynamic variables from campaign
;=============================================================================
